-- svg-no-rsvg.lua
-- 1) svg に対して rsvg-convert を走らせないことを実現する
-- 2) 任意の png をフォールバックに登録することで上記を行う (ここでは 1 x 1 透明 png)
-- 注意:
--   本来は、適切な png を下記の手法で svg と同じタイミングで登録するのが望ましい。

-- NOTE: 作っては見たが、現段階では、このフィルタは機能しない。
-- Lua フィルタで事前に png フォールバックを挿入するアプローチは、
-- Pandoc 本体の処理によって (svg のフォールバック png が必ず作成され同一キーで) 上書きされるため、
-- 実質的に機能しないと言えます。
-- この問題に対処するためには、画像ノードの差し替えなどの回避策を検討する必要があります。
-- また、将来的には Pandoc に rsvg-convert の実行を制御するオプションが追加されることが望まれます。

-- 1×1 fully-transparent PNG (89 bytes)s
local blank = string.char(
  0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A,
  0x00,0x00,0x00,0x0D,0x49,0x48,0x44,0x52,
  0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,
  0x08,0x06,0x00,0x00,0x00,0x1F,0x15,0xC4,0x89,
  0x00,0x00,0x00,0x0A,0x49,0x44,0x41,0x54,
  0x78,0x9C,0x63,0x00,0x01,0x00,0x00,0x05,0x00,0x01,
  0x0D,0x0A,0x2D,0xB4,
  0x00,0x00,0x00,0x00,0x49,0x45,0x4E,0x44,
  0xAE,0x42,0x60,0x82
)

function is_svg(path)
  return path:lower():match("%.svg$") ~= nil
end

function Image(img)
  --io.stderr:write("[svg-no-rsvg] img.src: " .. img.src .. "\n")
  if is_svg(img.src) then
    local fallback = img.src .. ".png"
    --io.stderr:write("[svg-no-rsvg] insert: " .. fallback .. "\n")
    if not pandoc.mediabag.lookup(fallback) then
      pandoc.mediabag.insert(fallback, "image/png", blank)
    end
  end
  return img   -- svg 本体はそのまま
end
