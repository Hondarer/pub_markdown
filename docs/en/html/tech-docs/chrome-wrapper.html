<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Tetsuo Honda" />
  <title>chrome-wrapper について</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../html-style.css" />
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">chrome-wrapper について</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Tetsuo Honda</p></li>
                              <li><p class="navbar-text">Wed, 25 Jun 2025 06:38:56 +0900 42af2d9</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#概要" id="toc-概要"><span class="toc-section-number">1</span> 概要</a></li>
        <li><a href="#背景と課題" id="toc-背景と課題"><span class="toc-section-number">2</span> 背景と課題</a>
        <ul>
        <li><a href="#puppeteer-の-websocket-接続問題" id="toc-puppeteer-の-websocket-接続問題"><span class="toc-section-number">2.1</span> Puppeteer の WebSocket 接続問題</a></li>
        <li><a href="#従来の対処法の問題点" id="toc-従来の対処法の問題点"><span class="toc-section-number">2.2</span> 従来の対処法の問題点</a></li>
        </ul></li>
        <li><a href="#アーキテクチャ" id="toc-アーキテクチャ"><span class="toc-section-number">3</span> アーキテクチャ</a>
        <ul>
        <li><a href="#ファイル構成" id="toc-ファイル構成"><span class="toc-section-number">3.1</span> ファイル構成</a></li>
        <li><a href="#処理フロー" id="toc-処理フロー"><span class="toc-section-number">3.2</span> 処理フロー</a></li>
        </ul></li>
        <li><a href="#技術仕様" id="toc-技術仕様"><span class="toc-section-number">4</span> 技術仕様</a>
        <ul>
        <li><a href="#環境変数の管理" id="toc-環境変数の管理"><span class="toc-section-number">4.1</span> 環境変数の管理</a></li>
        <li><a href="#ポート待機アルゴリズム" id="toc-ポート待機アルゴリズム"><span class="toc-section-number">4.2</span> ポート待機アルゴリズム</a></li>
        <li><a href="#出力バッファリング機構" id="toc-出力バッファリング機構"><span class="toc-section-number">4.3</span> 出力バッファリング機構</a></li>
        <li><a href="#fifo-による非同期処理" id="toc-fifo-による非同期処理"><span class="toc-section-number">4.4</span> FIFO による非同期処理</a></li>
        </ul></li>
        <li><a href="#使用方法" id="toc-使用方法"><span class="toc-section-number">5</span> 使用方法</a>
        <ul>
        <li><a href="#基本的なセットアップ" id="toc-基本的なセットアップ"><span class="toc-section-number">5.1</span> 基本的なセットアップ</a></li>
        <li><a href="#カスタム-chromium-パスの指定" id="toc-カスタム-chromium-パスの指定"><span class="toc-section-number">5.2</span> カスタム Chromium パスの指定</a></li>
        <li><a href="#既存プロジェクトへの統合" id="toc-既存プロジェクトへの統合"><span class="toc-section-number">5.3</span> 既存プロジェクトへの統合</a></li>
        </ul></li>
        <li><a href="#エラーハンドリング" id="toc-エラーハンドリング"><span class="toc-section-number">6</span> エラーハンドリング</a>
        <ul>
        <li><a href="#主要なエラーケース" id="toc-主要なエラーケース"><span class="toc-section-number">6.1</span> 主要なエラーケース</a></li>
        <li><a href="#デバッグ支援" id="toc-デバッグ支援"><span class="toc-section-number">6.2</span> デバッグ支援</a></li>
        <li><a href="#クリーンアップ処理" id="toc-クリーンアップ処理"><span class="toc-section-number">6.3</span> クリーンアップ処理</a></li>
        </ul></li>
        <li><a href="#トラブルシューティング" id="toc-トラブルシューティング"><span class="toc-section-number">7</span> トラブルシューティング</a>
        <ul>
        <li><a href="#よくある問題と解決方法" id="toc-よくある問題と解決方法"><span class="toc-section-number">7.1</span> よくある問題と解決方法</a></li>
        <li><a href="#ログ出力の確認" id="toc-ログ出力の確認"><span class="toc-section-number">7.2</span> ログ出力の確認</a></li>
        </ul></li>
        </ul>

        </div>
      </div>
            <div class="span9">

                <H1>chrome-wrapper について</H1>
      
      
      <h1 data-number="1" id="概要"><span class="header-section-number">1</span> 概要</h1>
<p>このスクリプト群は、Linux 環境下で Puppeteer を使用する際に発生する WebSocket 接続の競合状態 (race condition) を解決するための非破壊的な待機機構である。Puppeteer の Chromium 起動プロセスを透過的にラップし、DevTools WebSocket が完全に利用可能になるまで適切に待機することで、接続エラーを防止する。</p>
<h1 data-number="2" id="背景と課題"><span class="header-section-number">2</span> 背景と課題</h1>
<h2 data-number="2.1" id="puppeteer-の-websocket-接続問題"><span class="header-section-number">2.1</span> Puppeteer の WebSocket 接続問題</h2>
<p>Puppeteer は内部的に Chrome DevTools Protocol を使用して Chromium ブラウザを制御するが、この通信は WebSocket 接続を通じて行われる。特に WSL 環境や仮想環境では、以下の問題が発生する可能性がある:</p>
<ol type="1">
<li><strong>タイミング競合</strong>: Chromium が DevTools WebSocket ポートを開放したことを stderr に出力しても、実際にはまだポートが完全に利用可能でない場合がある</li>
<li><strong>接続拒否エラー</strong>: <code>connect ECONNREFUSED 127.0.0.1:{PORT}</code> エラーが発生し、<code>puppeteer.launch()</code> が失敗する</li>
<li><strong>非決定的な動作</strong>: 環境やシステム負荷により、成功したり失敗したりする不安定な挙動</li>
</ol>
<h2 data-number="2.2" id="従来の対処法の問題点"><span class="header-section-number">2.2</span> 従来の対処法の問題点</h2>
<p>一般的な対処法として以下が提案されることがあるが、それぞれに課題がある:</p>
<ul>
<li><strong>固定的な sleep</strong>: 環境により必要な待機時間が異なり、過剰な遅延を生む</li>
<li><strong>Puppeteer オプション調整</strong>: 根本的な解決にならない場合が多い</li>
<li><strong>リトライ機構</strong>: アプリケーションレイヤーでの複雑な実装が必要</li>
</ul>
<h1 data-number="3" id="アーキテクチャ"><span class="header-section-number">3</span> アーキテクチャ</h1>
<h2 data-number="3.1" id="ファイル構成"><span class="header-section-number">3.1</span> ファイル構成</h2>
<pre class="text"><code>chrome-wrapper.sh           # ラッパースクリプト
mmdc-wrapper.sh             # ラッパースクリプト
prepare_puppeteer_env.sh    # 環境設定用スクリプト</code></pre>
<h2 data-number="3.2" id="処理フロー"><span class="header-section-number">3.2</span> 処理フロー</h2>
<figure>
<img src="puml_707b3bde192a0faac5826137e3e897d4ccd22028.svg" alt="処理フロー" />
<figcaption aria-hidden="true">処理フロー</figcaption>
</figure>
<h1 data-number="4" id="技術仕様"><span class="header-section-number">4</span> 技術仕様</h1>
<h2 data-number="4.1" id="環境変数の管理"><span class="header-section-number">4.1</span> 環境変数の管理</h2>
<p>スクリプトは以下の環境変数を使用して非破壊的な動作を実現する:</p>
<ul>
<li><code>PUPPETEER_EXECUTABLE_PATH</code>: Puppeteer が使用する実行可能ファイルパス</li>
<li><code>ORG_PUPPETEER_EXECUTABLE_PATH</code>: 元の実行可能ファイルパスの退避用</li>
</ul>
<h2 data-number="4.2" id="ポート待機アルゴリズム"><span class="header-section-number">4.2</span> ポート待機アルゴリズム</h2>
<p>DevTools WebSocket ポートが完全に利用可能になるまでの確認は、以下の 2 段階で行われる:</p>
<ol type="1">
<li><p><strong>LISTEN 状態確認</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ss</span> <span class="at">-tln</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $1, $4}&#39;</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-E</span> <span class="st">&#39;^LISTEN\s+127\.0\.0\.1:&#39;&quot;</span><span class="va">$PORT</span><span class="st">&quot;&#39;$&#39;</span></span></code></pre></div></li>
<li><p><strong>API 応答確認</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-s</span> <span class="at">--max-time</span> 0.2 <span class="st">&quot;http://127.0.0.1:</span><span class="va">$PORT</span><span class="st">/json/version&quot;</span></span></code></pre></div></li>
</ol>
<h2 data-number="4.3" id="出力バッファリング機構"><span class="header-section-number">4.3</span> 出力バッファリング機構</h2>
<p>stderr の出力は以下のロジックでバッファリングされる:</p>
<ul>
<li>DevTools WebSocket 行が出現するまで、すべての stderr 出力をメモリ上にバッファリング</li>
<li>ポートが利用可能になった時点で、バッファされた出力を一括して Puppeteer に転送</li>
<li>その後の出力は通常通りリアルタイムで転送</li>
</ul>
<h2 data-number="4.4" id="fifo-による非同期処理"><span class="header-section-number">4.4</span> FIFO による非同期処理</h2>
<p>名前付きパイプ (FIFO) を使用して、Chromium プロセスの stderr 出力を非同期で処理する:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">FIFO</span><span class="op">=</span><span class="va">$(</span><span class="fu">mktemp</span> <span class="at">-u</span><span class="va">)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkfifo</span> <span class="st">&quot;</span><span class="va">$FIFO</span><span class="st">&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">trap</span> <span class="st">&#39;rm -f &quot;$FIFO&quot;&#39;</span> EXIT</span></code></pre></div>
<h1 data-number="5" id="使用方法"><span class="header-section-number">5</span> 使用方法</h1>
<h2 data-number="5.1" id="基本的なセットアップ"><span class="header-section-number">5.1</span> 基本的なセットアップ</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x chrome-wrapper.sh</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x prepare_puppeteer_env.sh</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> prepare_puppeteer_env.sh</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> your-puppeteer-script.js</span></code></pre></div>
<h2 data-number="5.2" id="カスタム-chromium-パスの指定"><span class="header-section-number">5.2</span> カスタム Chromium パスの指定</h2>
<p>特定の Chromium バイナリを使用したい場合:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">ORG_PUPPETEER_EXECUTABLE_PATH</span><span class="op">=</span><span class="st">&quot;/path/to/custom/chrome&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> prepare_puppeteer_env.sh</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> your-script.js</span></code></pre></div>
<h2 data-number="5.3" id="既存プロジェクトへの統合"><span class="header-section-number">5.3</span> 既存プロジェクトへの統合</h2>
<p>既存の Puppeteer プロジェクトに影響を与えることなく導入できる:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> chrome-wrapper.sh prepare_puppeteer_env.sh /your/project/</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> prepare_puppeteer_env.sh</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> start</span></code></pre></div>
<h1 data-number="6" id="エラーハンドリング"><span class="header-section-number">6</span> エラーハンドリング</h1>
<h2 data-number="6.1" id="主要なエラーケース"><span class="header-section-number">6.1</span> 主要なエラーケース</h2>
<ul>
<li><strong>Chromium 実行ファイル未発見</strong>: 適切なエラーメッセージで終了</li>
<li><strong>FIFO 作成失敗</strong>: システムの tmpfs 問題として診断可能</li>
<li><strong>ポート待機タイムアウト</strong>: 最大待機時間後に通常動作へフォールバック</li>
</ul>
<h2 data-number="6.2" id="デバッグ支援"><span class="header-section-number">6.2</span> デバッグ支援</h2>
<p>スクリプトは以下のデバッグ情報を stderr に出力する:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Chrome wrapper script started.&quot;</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span></code></pre></div>
<h2 data-number="6.3" id="クリーンアップ処理"><span class="header-section-number">6.3</span> クリーンアップ処理</h2>
<p>プロセス終了時に FIFO ファイルを確実に削除:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">trap</span> <span class="st">&#39;rm -f &quot;$FIFO&quot;&#39;</span> EXIT</span></code></pre></div>
<h1 data-number="7" id="トラブルシューティング"><span class="header-section-number">7</span> トラブルシューティング</h1>
<h2 data-number="7.1" id="よくある問題と解決方法"><span class="header-section-number">7.1</span> よくある問題と解決方法</h2>
<p><strong>問題</strong>: <code>ss: command not found</code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install iproute2</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install iproute</span></code></pre></div>
<p><strong>問題</strong>: <code>curl: command not found</code></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install curl</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install curl</span></code></pre></div>
<p><strong>問題</strong>: 権限エラー</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x chrome-wrapper.sh prepare_puppeteer_env.sh</span></code></pre></div>
<h2 data-number="7.2" id="ログ出力の確認"><span class="header-section-number">7.2</span> ログ出力の確認</h2>
<p>デバッグ時は以下の方法で詳細な動作を確認できる:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> your-script.js <span class="dv">2</span><span class="op">&gt;</span> debug.log</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ps</span> aux <span class="kw">|</span> <span class="fu">grep</span> chrome-wrapper</span></code></pre></div>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
